---
import PageLayout from '../layouts/PageLayout.astro';
---

<PageLayout title="Biblia 365 - Mi Amigo Anhelado">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" is:inline></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <style is:inline>
    :root {
      --primary: #1a4d2e;
      --accent: #d4a574;
      --bg-main: #faf8f5;
      --bg-secondary: #f0ebe3;
      --surface: rgba(255, 255, 255, 0.95);
      --text-main: #1a202c;
      --border: rgba(212, 165, 116, 0.2);
    }

    body.dark-mode {
      --bg-main: #0a0e0d;
      --bg-secondary: #1a1f1e;
      --surface: rgba(30, 37, 34, 0.95);
      --text-main: #f7fafc;
      --primary: #52b788;
      --accent: #f4a261;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: linear-gradient(135deg, var(--bg-main) 0%, var(--bg-secondary) 100%);
      background-attachment: fixed;
      color: var(--text-main);
      font-family: 'Crimson Text', serif;
      line-height: 1.8;
      min-height: 100-vh;
    }

    .main-container { max-width: 800px; margin: 0 auto; padding: 1.5rem; }

    /* Header y Progreso */
    .app-header { text-align: center; margin-bottom: 2rem; }
    .app-title { font-family: 'Playfair Display', serif; font-size: 3rem; font-weight: 900; color: var(--primary); }
    
    .progress-ring { display: flex; justify-content: center; margin: 1rem 0; }
    .ring-container { position: relative; width: 100px; height: 100px; }
    .ring-svg { transform: rotate(-90deg); }
    .ring-bg { fill: none; stroke: var(--border); stroke-width: 6; }
    .ring-progress { fill: none; stroke: var(--accent); stroke-width: 6; stroke-linecap: round; transition: 1s ease; }
    .ring-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }

    /* Panel de Control */
    .control-panel { 
      position: sticky; top: 10px; z-index: 100; 
      background: var(--surface); backdrop-filter: blur(10px); 
      padding: 1rem; border-radius: 20px; 
      display: flex; justify-content: space-between; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid var(--border);
      margin-bottom: 2rem;
    }
    
    .btn-tool { 
      background: var(--primary); color: white; border: none; 
      padding: 0.6rem 1rem; border-radius: 10px; cursor: pointer; font-weight: bold;
    }

    /* Biblioteca Modal */
    #modalBiblioteca { 
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
      display: none; place-items: center; z-index: 1000; padding: 1rem; 
    }
    .modal-content { 
      background: var(--bg-main); width: 100%; max-width: 600px; 
      max-height: 80vh; padding: 2rem; border-radius: 20px; overflow-y: auto; 
    }
    #gridLibros { 
      display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
      gap: 10px; margin-top: 1rem; 
    }
    .btn-libro-grid { 
      padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; 
      background: var(--surface); cursor: pointer; font-size: 0.9rem;
    }

    /* Lectura */
    .capitulo-card { background: var(--surface); border-radius: 15px; margin-bottom: 1.5rem; border: 1px solid var(--border); overflow: hidden; }
    .capitulo-header { background: var(--primary); color: white; padding: 1rem; text-align: center; }
    .versiculos { padding: 1.5rem; font-size: var(--user-font, 20px); }
    .versiculo { margin-bottom: 0.5rem; }
    .num { color: var(--accent); font-weight: bold; margin-right: 0.5rem; }

    .nav-footer { display: flex; gap: 10px; margin-top: 2rem; }
    .btn-nav { flex: 1; padding: 1rem; border-radius: 12px; border: none; background: var(--primary); color: white; cursor: pointer; }
  </style>

  <div class="main-container">
    <header class="app-header">
      <h1 class="app-title">BIBLIA 365</h1>
      <div class="progress-ring">
        <div class="ring-container">
          <svg class="ring-svg" width="100" height="100">
            <circle class="ring-bg" cx="50" cy="50" r="45" />
            <circle id="ringProgress" class="ring-progress" cx="50" cy="50" r="45" stroke-dasharray="283" stroke-dashoffset="283" />
          </svg>
          <div class="ring-text">
            <div id="ringDay" style="font-weight: bold; font-size: 1.2rem;">1</div>
            <div style="font-size: 0.6rem; opacity: 0.7;">D√çA</div>
          </div>
        </div>
      </div>
    </header>

    <div class="control-panel">
      <button class="btn-tool" onclick="abrirBiblioteca()">üìö Libros</button>
      <div style="display: flex; gap: 5px;">
        <button class="btn-tool" onclick="cambiarFuente(-2)">A-</button>
        <button class="btn-tool" onclick="cambiarFuente(2)">A+</button>
        <button class="btn-tool" onclick="toggleModo()">üåì</button>
      </div>
    </div>

    <div id="contenedorLectura"></div>

    <div class="nav-footer">
      <button class="btn-nav" onclick="cambiarDia(-1)">‚óÄ Anterior</button>
      <button class="btn-nav" onclick="irAHoy()">Hoy</button>
      <button class="btn-nav" onclick="cambiarDia(1)">Siguiente ‚ñ∂</button>
    </div>
  </div>

  <div id="modalBiblioteca" onclick="if(event.target==this) cerrarBiblioteca()">
    <div class="modal-content">
      <h2 style="text-align: center; margin-bottom: 1rem;">Seleccionar Libro</h2>
      <div id="gridLibros"></div>
    </div>
  </div>

  <script is:inline>
    const BIBLIA = [
      { n: 'G√©nesis', f: 'genesis', c: 50 }, { n: '√âxodo', f: 'exodo', c: 40 }, { n: 'Lev√≠tico', f: 'levitico', c: 27 },
      { n: 'N√∫meros', f: 'numeros', c: 36 }, { n: 'Deuteronomio', f: 'deuteronomio', c: 34 }, { n: 'Josu√©', f: 'josue', c: 24 },
      { n: 'Jueces', f: 'jueces', c: 21 }, { n: 'Rut', f: 'rut', c: 4 }, { n: '1 Samuel', f: '1_samuel', c: 31 },
      { n: '2 Samuel', f: '2_samuel', c: 24 }, { n: '1 Reyes', f: '1_reyes', c: 22 }, { n: '2 Reyes', f: '2_reyes', c: 25 },
      { n: '1 Cr√≥nicas', f: '1_cronicas', c: 29 }, { n: '2 Cr√≥nicas', f: '2_cronicas', c: 36 }, { n: 'Esdras', f: 'esdras', c: 10 },
      { n: 'Nehem√≠as', f: 'nehemias', c: 13 }, { n: 'Ester', f: 'ester', c: 10 }, { n: 'Job', f: 'job', c: 42 },
      { n: 'Salmos', f: 'salmos', c: 150 }, { n: 'Proverbios', f: 'proverbios', c: 31 }, { n: 'Eclesiast√©s', f: 'eclesiastes', c: 12 },
      { n: 'Cantares', f: 'cantares', c: 8 }, { n: 'Isa√≠as', f: 'isaias', c: 66 }, { n: 'Jerem√≠as', f: 'jeremias', c: 52 },
      { n: 'Lamentaciones', f: 'lamentaciones', c: 5 }, { n: 'Ezequiel', f: 'ezequiel', c: 48 }, { n: 'Daniel', f: 'daniel', c: 12 },
      { n: 'Mateo', f: 'mateo', c: 28 }, { n: 'Marcos', f: 'marcos', c: 16 }, { n: 'Lucas', f: 'lucas', c: 24 },
      { n: 'Juan', f: 'juan', c: 21 }, { n: 'Hechos', f: 'hechos', c: 28 }, { n: 'Apocalipsis', f: 'apocalipsis', c: 22 }
    ];

    let planCompleto = [];
    BIBLIA.forEach(libro => {
      for(let i = 1; i <= libro.c; i++) planCompleto.push({ n: libro.n, f: libro.f, c: i });
    });

    let fecha = new Date();
    let fontSize = 20;

    function renderBiblioteca() {
      const grid = document.getElementById('gridLibros');
      grid.innerHTML = BIBLIA.map(l => `
        <button class="btn-libro-grid" onclick="irALibro('${l.f}', '${l.n}')">${l.n}</button>
      `).join('');
    }

    window.abrirBiblioteca = () => {
      document.getElementById('modalBiblioteca').style.display = 'grid';
      renderBiblioteca();
    };

    window.cerrarBiblioteca = () => {
      document.getElementById('modalBiblioteca').style.display = 'none';
    };

    window.irALibro = (f, n) => {
      cerrarBiblioteca();
      cargarLectura([{ f, n, c: 1 }]);
    };

    async function cargarLectura(especifico = null) {
      const cont = document.getElementById('contenedorLectura');
      cont.innerHTML = '<p style="text-align:center">Cargando...</p>';

      let items = especifico;
      if (!especifico) {
        const inicio = new Date(fecha.getFullYear(), 0, 0);
        const diaNum = Math.floor((fecha - inicio) / 86400000);
        const idx = (diaNum - 1) * 3;
        items = planCompleto.slice(idx, idx + 3);
        
        document.getElementById('ringDay').innerText = diaNum;
        const offset = 283 - (diaNum / 365) * 283;
        document.getElementById('ringProgress').style.strokeDashoffset = offset;
      }

      let html = '';
      for (const it of items) {
        try {
          const res = await fetch(`https://bible-api.deno.dev/api/read/rvv1960/${it.f}/${it.c}`);
          const data = await res.json();
          html += `
            <div class="capitulo-card">
              <div class="capitulo-header"><h2>${it.n} ${it.c}</h2></div>
              <div class="versiculos">
                ${data.vers.map(v => `<p class="versiculo"><span class="num">${v.number}</span>${v.verse}</p>`).join('')}
              </div>
            </div>
          `;
        } catch (e) { console.error(e); }
      }
      cont.innerHTML = html;
    }

    window.cambiarFuente = (n) => {
      fontSize += n;
      document.documentElement.style.setProperty('--user-font', fontSize + 'px');
    };

    window.toggleModo = () => document.body.classList.toggle('dark-mode');
    window.cambiarDia = (d) => { fecha.setDate(fecha.getDate() + d); cargarLectura(); };
    window.irAHoy = () => { fecha = new Date(); cargarLectura(); };

    // Iniciar
    cargarLectura();
  </script>
</PageLayout>